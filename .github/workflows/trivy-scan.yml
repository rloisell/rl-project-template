# Trivy Security Scan
# Author: Ryan Loiselle | Template: rl-project-template | Date: 2026-02-28
#
# Two jobs:
#   trivy-fs:    Scans the source tree on every PR — blocks on CRITICAL/HIGH CVEs in deps.
#   trivy-image: Scans the built container image on push to develop — run post-build.
#
# Requires GitHub secret: ARTIFACTORY_URL (for image job — set to your Artifactory registry host)
# trivy-fs does NOT require any secrets.

name: Trivy Security Scan

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop

permissions:
  contents: read
  security-events: write   # required to upload SARIF to GitHub Security tab (GHAS)

jobs:

  # ── FILESYSTEM SCAN ── Runs on PR — no build required
  trivy-fs:
    name: Trivy FS Scan
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type:     'fs'
          scan-ref:      '.'
          severity:      'CRITICAL,HIGH'
          exit-code:     '1'
          ignore-unfixed: true
          format:        'sarif'
          output:        'trivy-fs-results.sarif'

      - name: Upload Trivy FS SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs-results.sarif
          category:   trivy-fs

  # ── IMAGE SCAN ── Runs on push to develop after build-and-push.yml completes
  trivy-image:
    name: Trivy Image Scan
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: echo "tag=dev-${GITHUB_SHA::7}-${{ github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ARTIFACTORY_URL }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: Run Trivy image scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type:     'image'
          image-ref:     '${{ secrets.ARTIFACTORY_URL }}/<KEY>-docker-local/<APP_NAME>:${{ steps.tag.outputs.tag }}'
          severity:      'CRITICAL,HIGH'
          exit-code:     '1'
          ignore-unfixed: true
          format:        'sarif'
          output:        'trivy-image-results.sarif'

      - name: Upload Trivy image SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-image-results.sarif
          category:   trivy-image
