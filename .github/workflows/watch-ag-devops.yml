name: Watch bcgov/ag-devops for changes

# Runs weekly on Monday morning. When monitored paths in ag-devops change,
# opens a GitHub Issue listing which agent skills to review.
#
# Baseline (tree SHAs) is stored in the ag-devops-baseline branch — an orphan
# branch with no protection rules, so GITHUB_TOKEN can push freely.
#
# First run with action: baseline initialises the SHAs.
# Re-run with action: baseline after applying upstream changes.

on:
  schedule:
    - cron: '0 14 * * 1'
  workflow_dispatch:
    inputs:
      action:
        description: 'check (default) or baseline (advance stored SHAs after applying changes)'
        required: false
        default: check

permissions:
  contents: write
  issues: write

jobs:
  watch:
    name: Detect ag-devops changes
    runs-on: ubuntu-latest
    env:
      UPSTREAM: bcgov/ag-devops
      BASELINE_BRANCH: ag-devops-baseline
      BASELINE_FILE: ag-devops-baseline.json

    steps:
      - name: Checkout baseline branch
        uses: actions/checkout@v4
        with:
          ref: ag-devops-baseline
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch upstream tree SHAs
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          fetch_sha() {
            gh api "repos/$UPSTREAM/contents/$1" \
              --jq 'if type == "array" then map(.sha) | sort | join(",") else .sha end' \
              2>/dev/null || echo "not-found"
          }
          DOCS_SHA=$(fetch_sha "docs")
          POLICIES_SHA=$(fetch_sha "cd/policies")
          HELM_SHA=$(fetch_sha "helm")
          HEAD_SHA=$(gh api "repos/$UPSTREAM/commits/main" --jq '.sha' 2>/dev/null || echo "unknown")
          echo "docs => $DOCS_SHA"
          echo "cd/policies => $POLICIES_SHA"
          echo "helm => $HELM_SHA"
          echo "HEAD => $HEAD_SHA"
          echo "docs_sha=$DOCS_SHA" >> "$GITHUB_OUTPUT"
          echo "policies_sha=$POLICIES_SHA" >> "$GITHUB_OUTPUT"
          echo "helm_sha=$HELM_SHA" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Compare with stored baseline
        id: compare
        env:
          CURRENT_DOCS: ${{ steps.upstream.outputs.docs_sha }}
          CURRENT_POLICIES: ${{ steps.upstream.outputs.policies_sha }}
          CURRENT_HELM: ${{ steps.upstream.outputs.helm_sha }}
        run: |
          BL_DOCS=$(python3 -c "import json; d=json.load(open('$BASELINE_FILE')); print(d.get('docs',''))" 2>/dev/null || echo "")
          BL_POLICIES=$(python3 -c "import json; d=json.load(open('$BASELINE_FILE')); print(d.get('cd/policies',''))" 2>/dev/null || echo "")
          BL_HELM=$(python3 -c "import json; d=json.load(open('$BASELINE_FILE')); print(d.get('helm',''))" 2>/dev/null || echo "")

          CHANGED=""
          [ "$CURRENT_DOCS" != "$BL_DOCS" ] && CHANGED="${CHANGED}  - docs/: ${BL_DOCS:0:12} -> ${CURRENT_DOCS:0:12}\n"
          [ "$CURRENT_POLICIES" != "$BL_POLICIES" ] && CHANGED="${CHANGED}  - cd/policies/: ${BL_POLICIES:0:12} -> ${CURRENT_POLICIES:0:12}\n"
          [ "$CURRENT_HELM" != "$BL_HELM" ] && CHANGED="${CHANGED}  - helm/: ${BL_HELM:0:12} -> ${CURRENT_HELM:0:12}\n"

          if [ "$BL_DOCS" = "not-yet-baselined" ] || [ -z "$BL_DOCS" ]; then
            echo "first_run=true" >> "$GITHUB_OUTPUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          elif [ -n "$CHANGED" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            printf "diff_output<<DELIM\n%b\nDELIM\n" "$CHANGED" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open change-alert issue
        if: >
          steps.compare.outputs.changed == 'true' &&
          (github.event.inputs.action == '' || github.event.inputs.action == 'check')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA: ${{ steps.upstream.outputs.head_sha }}
          FIRST_RUN: ${{ steps.compare.outputs.first_run }}
          DIFF: ${{ steps.compare.outputs.diff_output }}
        run: |
          if [ "$FIRST_RUN" = "true" ]; then
            gh issue create \
              --title "ag-devops watch: baseline initialised" \
              --body "## ag-devops Baseline Initialised

          Baseline stored in the \`ag-devops-baseline\` branch.

          **Upstream HEAD:** [\`${HEAD_SHA:0:12}\`](https://github.com/$UPSTREAM/commit/$HEAD_SHA)

          Future weekly runs will alert when monitored paths change." \
              --label "agent-skills,dependencies" 2>/dev/null \
              || gh issue create --title "ag-devops watch: baseline initialised" --body "Baseline initialised. HEAD: $HEAD_SHA"
          else
            gh issue create \
              --title "ag-devops upstream changed — review agent skills" \
              --body "## bcgov/ag-devops has changed

          **HEAD:** [\`${HEAD_SHA:0:12}\`](https://github.com/$UPSTREAM/commit/$HEAD_SHA) — https://github.com/$UPSTREAM/commits/main

          ### Changed paths

          $DIFF

          ### Agent skills to review

          | Changed path | Skills to update |
          |---|---|
          | \`docs/\` | \`bc-gov-devops/SKILL.md\`, \`networkpolicy-patterns.md\`, \`ci-cd-pipeline/SKILL.md\` |
          | \`cd/policies/\` | \`ci-cd-pipeline/SKILL.md\` (Policy-as-Code Gate) |
          | \`helm/\` | \`bc-gov-devops/SKILL.md\` (ag-helm section), \`bc-gov-emerald/SKILL.md\` |

          ### Process
          1. Review diff at https://github.com/$UPSTREAM/commits/main
          2. Ask Copilot to apply relevant changes to the agent skills
          3. Re-baseline: Actions → Watch bcgov/ag-devops → Run workflow → action: baseline

          > .NET stays at 10. ag-helm is a reference pattern, not mandatory." \
              --label "agent-skills,dependencies" 2>/dev/null \
              || gh issue create --title "ag-devops upstream changed — review agent skills" --body "Changes detected. HEAD: $HEAD_SHA. Diff: $DIFF"
          fi

      - name: Update baseline file
        if: >
          steps.compare.outputs.changed == 'true' ||
          github.event.inputs.action == 'baseline'
        env:
          DOCS_SHA: ${{ steps.upstream.outputs.docs_sha }}
          POLICIES_SHA: ${{ steps.upstream.outputs.policies_sha }}
          HELM_SHA: ${{ steps.upstream.outputs.helm_sha }}
          HEAD_SHA: ${{ steps.upstream.outputs.head_sha }}
        run: |
          python3 - <<PYEOF
          import json, os
          data = {
              "_note": "Managed by watch-ag-devops.yml",
              "docs": os.environ["DOCS_SHA"],
              "cd/policies": os.environ["POLICIES_SHA"],
              "helm": os.environ["HELM_SHA"],
              "HEAD": os.environ["HEAD_SHA"],
          }
          with open(os.environ.get("BASELINE_FILE", "ag-devops-baseline.json"), "w") as f:
              json.dump(data, f, indent=2)
          print(json.dumps(data, indent=2))
          PYEOF

      - name: Commit and push baseline
        if: >
          steps.compare.outputs.changed == 'true' ||
          github.event.inputs.action == 'baseline'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$BASELINE_FILE"
          git diff --cached --quiet && echo "No changes." && exit 0
          git commit -m "chore: update ag-devops watch baseline [skip ci]"
          git push origin "$BASELINE_BRANCH"
          echo "Baseline updated on $BASELINE_BRANCH."

      - name: No changes detected
        if: steps.compare.outputs.changed == 'false'
        run: |
          echo "ag-devops monitored paths unchanged since last baseline."
          cat "$BASELINE_FILE"
