name: Watch bcgov/ag-devops for changes

# Runs weekly on Monday morning. When monitored paths in ag-devops change,
# opens a GitHub Issue summarising what changed and which agent skills to review.
#
# Baseline is stored as repository variables (AG_DEVOPS_*_SHA) — no git push
# required, so branch protection rules are irrelevant.
# Initialise by running manually with action: baseline.

on:
  schedule:
    - cron: '0 14 * * 1'   # Every Monday at 06:00 PT / 14:00 UTC
  workflow_dispatch:
    inputs:
      action:
        description: '"check" (default) or "baseline" (update repo variables after applying changes)'
        required: false
        default: check

permissions:
  issues: write         # to open alert issues
  # variables: write is not a permission — gh variable set uses GITHUB_TOKEN
  # which has implicit repo variable write access for Actions

jobs:
  watch:
    name: Detect ag-devops changes
    runs-on: ubuntu-latest

    env:
      UPSTREAM: bcgov/ag-devops

    steps:
      # No checkout needed — we only call GitHub API and manage repo variables.

      # ── Fetch current tree SHAs from ag-devops via GitHub API ────────────────
      - name: Fetch upstream tree SHAs
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching tree SHAs from $UPSTREAM ..."

          fetch_sha() {
            gh api "repos/$UPSTREAM/contents/$1" \
              --jq 'if type == "array" then map(.sha) | sort | join(",") else .sha end' \
              2>/dev/null || echo "not-found"
          }

          DOCS_SHA=$(fetch_sha "docs")
          POLICIES_SHA=$(fetch_sha "cd/policies")
          HELM_SHA=$(fetch_sha "helm")
          HEAD_SHA=$(gh api "repos/$UPSTREAM/commits/main" --jq '.sha' 2>/dev/null \
                     || echo "unknown")

          echo "  docs        => $DOCS_SHA"
          echo "  cd/policies => $POLICIES_SHA"
          echo "  helm        => $HELM_SHA"
          echo "  HEAD        => $HEAD_SHA"

          {
            echo "docs_sha=$DOCS_SHA"
            echo "policies_sha=$POLICIES_SHA"
            echo "helm_sha=$HELM_SHA"
            echo "head_sha=$HEAD_SHA"
          } >> "$GITHUB_OUTPUT"

      # ── Compare against baseline stored in repository variables ─────────────
      - name: Compare with baseline
        id: compare
        env:
          CURRENT_DOCS:      ${{ steps.upstream.outputs.docs_sha }}
          CURRENT_POLICIES:  ${{ steps.upstream.outputs.policies_sha }}
          CURRENT_HELM:      ${{ steps.upstream.outputs.helm_sha }}
          BASELINE_DOCS:     ${{ vars.AG_DEVOPS_DOCS_SHA }}
          BASELINE_POLICIES: ${{ vars.AG_DEVOPS_POLICIES_SHA }}
          BASELINE_HELM:     ${{ vars.AG_DEVOPS_HELM_SHA }}
        run: |
          CHANGED=""

          [[ "$CURRENT_DOCS" != "$BASELINE_DOCS" ]] && \
            CHANGED+="  - \`docs/\`: \`${BASELINE_DOCS:0:12}\` -> \`${CURRENT_DOCS:0:12}\`\n"

          [[ "$CURRENT_POLICIES" != "$BASELINE_POLICIES" ]] && \
            CHANGED+="  - \`cd/policies/\`: \`${BASELINE_POLICIES:0:12}\` -> \`${CURRENT_POLICIES:0:12}\`\n"

          [[ "$CURRENT_HELM" != "$BASELINE_HELM" ]] && \
            CHANGED+="  - \`helm/\`: \`${BASELINE_HELM:0:12}\` -> \`${CURRENT_HELM:0:12}\`\n"

          if [[ -z "$BASELINE_DOCS" && -z "$BASELINE_POLICIES" && -z "$BASELINE_HELM" ]]; then
            echo "No baseline variables found — first run."
            echo "first_run=true" >> "$GITHUB_OUTPUT"
            echo "changed=true"   >> "$GITHUB_OUTPUT"
          elif [[ -n "$CHANGED" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            {
              echo "diff_output<<DELIM"
              printf '%b' "$CHANGED"
              echo "DELIM"
            } >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Open a GitHub Issue when changes detected ─────────────────────────────
      - name: Open change-alert issue
        if: |
          steps.compare.outputs.changed == 'true' &&
          (github.event.inputs.action == '' || github.event.inputs.action == 'check')
        env:
          GH_TOKEN:  ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA:  ${{ steps.upstream.outputs.head_sha }}
          FIRST_RUN: ${{ steps.compare.outputs.first_run }}
          DIFF:      ${{ steps.compare.outputs.diff_output }}
        run: |
          if [[ "$FIRST_RUN" == "true" ]]; then
            TITLE="ag-devops watch: baseline initialised"
            BODY="## ag-devops Baseline Initialised

          The \`watch-ag-devops\` workflow ran for the first time.
          Baseline SHAs stored as repository variables \`AG_DEVOPS_*_SHA\`.

          **Upstream HEAD:** [\`${HEAD_SHA:0:12}\`](https://github.com/$UPSTREAM/commit/$HEAD_SHA)

          Future weekly runs will alert when monitored paths change."
          else
            TITLE="ag-devops upstream changed — review agent skills"
            BODY="## bcgov/ag-devops has changed

          **Upstream HEAD:** [\`${HEAD_SHA:0:12}\`](https://github.com/$UPSTREAM/commit/$HEAD_SHA)
          **Compare:** https://github.com/$UPSTREAM/commits/main

          ### Changed paths

          ${DIFF}

          ### Agent skills to review

          | Changed path | Skills to update |
          |---|---|
          | \`docs/\` | \`bc-gov-devops/SKILL.md\`, \`networkpolicy-patterns.md\`, \`ci-cd-pipeline/SKILL.md\` |
          | \`cd/policies/\` | \`ci-cd-pipeline/SKILL.md\` (Policy-as-Code Gate section) |
          | \`helm/\` | \`bc-gov-devops/SKILL.md\` (ag-helm section), \`bc-gov-emerald/SKILL.md\` |

          ### Process

          1. Review diff at https://github.com/$UPSTREAM/commits/main
          2. Ask Copilot: *\"Review the latest changes in bcgov/ag-devops and apply any updates to the agent skills.\"
          3. Re-baseline: **Actions -> Watch bcgov/ag-devops -> Run workflow -> action: baseline**

          > .NET version stays at **10**. ag-helm is a reference pattern, not mandatory."
          fi

          gh issue create --title "$TITLE" --body "$BODY" \
            --label "agent-skills,dependencies" 2>/dev/null \
            || gh issue create --title "$TITLE" --body "$BODY"

      # ── Update baseline stored as repository variables ────────────────────────
      - name: Update baseline variables
        if: |
          steps.compare.outputs.changed == 'true' ||
          github.event.inputs.action == 'baseline'
        env:
          GH_TOKEN:     ${{ secrets.GITHUB_TOKEN }}
          DOCS_SHA:     ${{ steps.upstream.outputs.docs_sha }}
          POLICIES_SHA: ${{ steps.upstream.outputs.policies_sha }}
          HELM_SHA:     ${{ steps.upstream.outputs.helm_sha }}
        run: |
          REPO="${{ github.repository }}"
          gh variable set AG_DEVOPS_DOCS_SHA     --body "$DOCS_SHA"     --repo "$REPO"
          gh variable set AG_DEVOPS_POLICIES_SHA --body "$POLICIES_SHA" --repo "$REPO"
          gh variable set AG_DEVOPS_HELM_SHA     --body "$HELM_SHA"     --repo "$REPO"
          echo "Baseline variables updated:"
          echo "  AG_DEVOPS_DOCS_SHA     = $DOCS_SHA"
          echo "  AG_DEVOPS_POLICIES_SHA = $POLICIES_SHA"
          echo "  AG_DEVOPS_HELM_SHA     = $HELM_SHA"

      - name: No changes detected
        if: steps.compare.outputs.changed == 'false'
        run: |
          echo "ag-devops monitored paths unchanged since last baseline."
          echo "  docs        = ${{ vars.AG_DEVOPS_DOCS_SHA }}"
          echo "  cd/policies = ${{ vars.AG_DEVOPS_POLICIES_SHA }}"
          echo "  helm        = ${{ vars.AG_DEVOPS_HELM_SHA }}"
