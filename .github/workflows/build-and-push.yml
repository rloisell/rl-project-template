# .github/workflows/build-and-push.yml
# Ryan Loisell - Developer / Architect | GitHub Copilot | February 2026
# AI-assisted: reviewed and directed by Ryan Loisell.
#
# Builds API and frontend container images and pushes them to BC Gov Artifactory.
#
# Per ISB EA Option 2 (preferred GitOps pattern for Emerald):
#   develop branch -> direct commit to dev_values.yaml   (ArgoCD auto-sync)
#   test branch    -> direct commit to test_values.yaml  (ArgoCD auto-sync)
#   main branch / v* semver tag -> opens a PR to the gitops repo targeting
#     prod_values.yaml.  A reviewer must approve the PR before ArgoCD syncs
#     to <LICENSE>-prod.  Semver tags use the version (e.g. v1.0.1) as the
#     image tag; branches use the short commit SHA.
#
# Placeholders to replace:
#   <LICENSE>     BC Gov project license plate (e.g., be808f)
#   <APP_NAME>    App slug for image names + values file keys (e.g., dsc)
#   <GITOPS_REPO> Full GitHub repo path for the gitops repo (e.g., org/app-gitops)
#
# Required GitHub Secrets (in THIS repo):
#   ARTIFACTORY_USERNAME   BC Gov Artifactory service account username
#   ARTIFACTORY_PASSWORD   BC Gov Artifactory service account password / token
#   GITOPS_TOKEN           GitHub PAT with repo write access to <GITOPS_REPO>

name: Build and Push

on:
  push:
    branches:
      - main       # -> prod PR in gitops repo
      - test       # -> direct commit to test_values.yaml
      - develop    # -> direct commit to dev_values.yaml
    tags:
      - "v*"       # semver release tags -> prod PR with version as image tag
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY:    artifacts.developer.gov.bc.ca
  NAMESPACE:   <LICENSE>-docker-local
  API_IMAGE:   <APP_NAME>-api
  WEB_IMAGE:   <APP_NAME>-frontend
  GITOPS_REPO: <GITOPS_REPO>

jobs:

  # -- Build & push images ----------------------------------------------------
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Image tag strategy (per ISB EA Option 2 guidance):
      #   v* semver tag  -> use the tag name as-is (e.g. v1.0.1)
      #   branch push    -> short SHA for per-commit traceability
      - name: Compute image tag
        id: meta
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "image_tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to Artifactory
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      # -- API image ----------------------------------------------------------
      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context:    .
          file:       containerization/Containerfile.api
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ github.ref_name }}

      # -- Frontend image -----------------------------------------------------
      - name: Build Frontend image
        uses: docker/build-push-action@v6
        with:
          context:    .
          file:       containerization/Containerfile.frontend
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ steps.meta.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ github.ref_name }}

      # -- Trivy vulnerability scans -----------------------------------------
      # Informational only (does not fail the pipeline).
      # Scans the pushed images for HIGH and CRITICAL CVEs.
      # Must run after docker/login-action so Trivy can pull from Artifactory.
      - name: Trivy scan — API image
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type:                  image
          image-ref:                  ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.image_tag }}
          format:                     table
          ignore-unfixed:             true
          limit-severities-for-sarif: true
          severity:                   HIGH,CRITICAL

      - name: Trivy scan — Frontend image
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type:                  image
          image-ref:                  ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ steps.meta.outputs.image_tag }}
          format:                     table
          ignore-unfixed:             true
          limit-severities-for-sarif: true
          severity:                   HIGH,CRITICAL

  # -- Update gitops (dev/test) -----------------------------------------------
  # Direct commit to the gitops repo for develop and test branches.
  # ArgoCD detects the change and auto-syncs to the matching namespace.
  # Prod updates use the create-prod-pr job below instead.
  update-gitops:
    name: Update GitOps Values (dev/test)
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'push' &&
      contains(fromJson('["test","develop"]'), github.ref_name)

    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token:      ${{ secrets.GITOPS_TOKEN }}
          ref:        main

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Resolve target values file
        id: env
        run: |
          case "${{ github.ref_name }}" in
            develop) echo "values_file=deploy/dev_values.yaml"  >> "$GITHUB_OUTPUT" ;;
            test)    echo "values_file=deploy/test_values.yaml" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Update API image tag
        run: yq -i '.<APP_NAME>.api.image.tag = "${{ needs.build.outputs.image_tag }}"' ${{ steps.env.outputs.values_file }}

      - name: Update Frontend image tag
        run: yq -i '.<APP_NAME>.frontend.image.tag = "${{ needs.build.outputs.image_tag }}"' ${{ steps.env.outputs.values_file }}

      - name: Commit and push updated values
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.env.outputs.values_file }}
          git diff --staged --quiet || \
            git commit -m "chore(<APP_NAME>): bump image tags to ${{ needs.build.outputs.image_tag }} [${{ github.ref_name }}]"
          git push

  # -- Create prod PR ---------------------------------------------------------
  # Per ISB EA Option 2: production deployments must go through a reviewed PR
  # in the gitops repo -- never a direct commit.  A maintainer approves the PR;
  # on merge ArgoCD syncs <LICENSE>-prod automatically.
  #
  # Triggered by:
  #   - push to main branch (uses short SHA as image tag)
  #   - push of a v* semver tag (e.g. v1.0.1 -> image tag v1.0.1)
  create-prod-pr:
    name: Open Prod Deployment PR
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'push' && (
        github.ref_name == 'main' ||
        startsWith(github.ref, 'refs/tags/v')
      )

    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token:      ${{ secrets.GITOPS_TOKEN }}
          ref:        main

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Create release branch
        id: branch
        run: |
          BRANCH="chore/<APP_NAME>-prod-${{ needs.build.outputs.image_tag }}"
          git checkout -b "${BRANCH}"
          echo "name=${BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Update prod image tags
        run: |
          yq -i '.<APP_NAME>.api.image.tag      = "${{ needs.build.outputs.image_tag }}"' deploy/prod_values.yaml
          yq -i '.<APP_NAME>.frontend.image.tag = "${{ needs.build.outputs.image_tag }}"' deploy/prod_values.yaml

      - name: Commit and push branch
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add deploy/prod_values.yaml
          git commit -m "chore(<APP_NAME>): bump prod image tags to ${{ needs.build.outputs.image_tag }}"
          git push origin "${{ steps.branch.outputs.name }}"

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          gh pr create \
            --repo "${{ env.GITOPS_REPO }}" \
            --base main \
            --head "${{ steps.branch.outputs.name }}" \
            --title "chore(<APP_NAME>): promote to prod -- ${{ needs.build.outputs.image_tag }}" \
            --body "## Production Deployment

          **Image tag:** \`${{ needs.build.outputs.image_tag }}\`
          **Source commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Triggered by:** \`${{ github.ref_name }}\` on \`${{ github.repository }}\`

          This PR updates \`deploy/prod_values.yaml\` with the new image tags.
          ArgoCD will sync to \`<LICENSE>-prod\` automatically on merge.

          > **Requires maintainer approval before merging.**"
