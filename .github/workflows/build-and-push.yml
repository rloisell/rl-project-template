# .github/workflows/build-and-push.yml
# Ryan Loiselle — Developer / Architect
# GitHub Copilot — AI pair programmer / code generation
# February 2026
#
# AI-assisted: GitHub Actions CI workflow for BC Gov Emerald deployment pipeline;
# reviewed and directed by Ryan Loiselle.
#
# Builds API and frontend Docker images and pushes them to BC Gov Artifactory.
# Triggered on push to main/develop/test branches and on version tags.
#
# Replace <LICENSE> with the BC Gov project license plate (e.g., be808f).
# Replace <APP_NAME> with the app name slug (e.g., dsc).
# Replace <GITOPS_REPO> with the GitOps repo (e.g., rloisell/dsc-gitops).
#
# Required GitHub Secrets:
#   ARTIFACTORY_USERNAME  — Artifactory service account username
#   ARTIFACTORY_PASSWORD  — Artifactory service account password or API key
#   GITOPS_TOKEN          — GitHub PAT with write access to the GitOps repo

name: Build and Push to Artifactory

on:
  push:
    branches:
      - main
      - develop
      - test
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read

env:
  REGISTRY: artifacts.developer.gov.bc.ca
  # Replace with your Artifactory project path
  REGISTRY_PROJECT: artifacts.developer.gov.bc.ca/<LICENSE>/<APP_NAME>
  # Short SHA used as image tag for traceability
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ── BUILD & PUSH ──────────────────────────────────────────────────────────────
  build-and-push:
    name: Build and push images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Log in to BC Gov Artifactory
      - name: Log in to Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      # ── API IMAGE ──────────────────────────────────────────────────────────
      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containerization/Containerfile.api
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY_PROJECT }}-api:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY_PROJECT }}-api:latest
          # Cache layers in Artifactory to speed up build on successive runs
          cache-from: type=registry,ref=${{ env.REGISTRY_PROJECT }}-api:latest
          cache-to: type=inline

      # ── FRONTEND IMAGE ─────────────────────────────────────────────────────
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containerization/Containerfile.frontend
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY_PROJECT }}-frontend:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY_PROJECT }}-frontend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_PROJECT }}-frontend:latest
          cache-to: type=inline

  # ── UPDATE GITOPS ─────────────────────────────────────────────────────────────
  # After a successful push to a tracked branch, update the image tag in the
  # GitOps repo so ArgoCD picks up the new image automatically.
  # Only runs on branch pushes — not on pull requests.
  update-gitops:
    name: Update GitOps image tag
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'

    steps:
      - name: Determine target environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "values_file=deploy/dev_values.yaml" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/test" ]]; then
            echo "values_file=deploy/test_values.yaml" >> $GITHUB_OUTPUT
          fi

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: <GITOPS_REPO>
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      # Update the image tag in the environment-specific values file.
      # Uses yq to surgically update the tag value without reformatting the file.
      - name: Update image tags in values file
        run: |
          cd gitops
          yq e -i '.<APP_NAME>.api.image.tag = "${{ env.IMAGE_TAG }}"' ${{ steps.env.outputs.values_file }}
          yq e -i '.<APP_NAME>.frontend.image.tag = "${{ env.IMAGE_TAG }}"' ${{ steps.env.outputs.values_file }}

      - name: Commit and push updated tags
        run: |
          cd gitops
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.env.outputs.values_file }}
          git commit -m "chore: update image tags to ${{ env.IMAGE_TAG }}" \
            -m "Triggered by ${{ github.repository }}@${{ github.sha }}"
          git push
